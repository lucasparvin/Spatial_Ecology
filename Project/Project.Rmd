---
title: "Project: Avian SDMs"
author: "Lucas Parvin"
date: "3-28-2024"
output:
  html_document:
    df_print: paged
---

# Load Packages

```{r, warning=F, error=F, message=F}
require(terra)
require(tidyterra)
require(sf)
require(adehabitatHR)
require(adehabitatLT)
require(adehabitatHS)
require(tidyverse)
require(survival)
require(geodata)
require(FedData)
require(tigris)
require(sampling)

```


# Import Needed Data
```{r, warning=F, error=F, message=F}
#alabama <- states() %>% 
 # filter(NAME=='Alabama')

# Load perdido
perdido <- st_read("Perdido_ICP1.shp")

# Plot
ggplot(data = perdido) +
  geom_sf() +
  theme_minimal() +
  ggtitle("Perdido")

# Convert 'perdido' to a terra SpatVector for compatibility with terra functions
perdido_vect <- vect(perdido)
crs_perdido <- crs(perdido_vect)

elevation <- get_ned(perdido_vect, label='Elevation')
elevation <- project(elevation, crs_perdido)
elevation_raster <- writeRaster(elevation, 'elevation_reprojected.tif', overwrite=TRUE)

# Check CRS of both 'perdido' and 'elevation'
crs_perdido <- crs(perdido_vect)
crs_elevation <- crs(elevation)

# Print CRS information for both
print(crs_perdido)
print(crs_elevation)

```

```{r}

# Assuming 'elevation' is the reprojected raster loaded and ready for clipping
# Crop and mask the elevation to the 'perdido_vect' boundary
elevation_clipped <- crop(elevation, perdido_vect)
elevation_clipped <- mask(elevation_clipped, perdido_vect)


# Convert clipped elevation raster to a data frame for plotting
elevation_df <- as.data.frame(elevation_clipped, xy = TRUE)

# Plot using ggplot2
ggplot() +
  geom_raster(data = elevation_df, aes(x = x, y = y, fill = Layer_1)) +
  scale_fill_viridis_c() + # This uses a color gradient from the viridis package
  coord_fixed() + # Keep aspect ratio of the map consistent
  theme_minimal() +
  labs(title = "Clipped Elevation within Perdido", fill = "Elevation") +
  geom_sf(data = perdido, inherit.aes = FALSE, fill = NA, color = "black") # Overlay the 'perdido' boundary

```

```{r}








# Optional: Clip the elevation raster to the bounds of the 'perdido' shapefile
elevation_clipped <- crop(elevation_raster, perdido)
elevation_clipped <- mask(elevation_clipped, perdido)

# Convert the clipped raster to a dataframe for ggplot
elevation_df <- as.data.frame(elevation_clipped, xy = TRUE, na.rm = TRUE)

# Plotting with ggplot2
ggplot() +
  geom_raster(data = elevation_df, aes(x = x, y = y, fill = layer)) +
  scale_fill_viridis_c(option = "magma", name = "Elevation (m)") +
  coord_equal() +
  theme_minimal() +
  labs(title = "Elevation Plot within Perdido Area") +
  geom_sf(data = perdido, inherit.aes = FALSE, fill = NA, color = "white")




```

```{r}
slope = terrain(elevation, v='slope', neighbors=8, unit='degrees')
#terra::writeRaster(slope, 'slope.tif', overwrite=TRUE)
ggplot(slope, aes(x=x, y=y, fill=slope))+
  scale_fill_gradientn(colours = terrain.colors(7))+
  geom_raster()+
  coord_equal()+
  theme_bw()+
  theme(panel.grid=element_blank())

aspect = terrain(elevation, v='aspect', neighbors=8, unit='degrees')
#terra::writeRaster(aspect, 'aspect.tif', overwrite=TRUE)
ggplot(aspect, aes(x=x, y=y, fill=aspect))+
  scale_fill_gradientn(colours = terrain.colors(7))+
  geom_raster()+
  coord_equal()+
  theme_bw()+
  theme(panel.grid=element_blank())


elevation_Variables = c(elevation, slope, aspect)

names(elevation_Variables) = c('elev', 'slope', 'aspect')


# terrain <- terra::terrain(ned, v="slope") %>%
#   project("EPSG:5070", method="bilinear")
# terrainRs <- terra::resample(terrain, nlcd)
# terra::writeRaster(terrainRs, 'terrain_resampled30m.tif', overwrite=TRUE)

#wma <- read_sf('ICPTracts_PhaseII/ICPTracts_PhaseII.shp')
#nlcd <- rast('nlcd.tif')
#ned <- rast('ned.tif')
#terrainRs <- rast('terrain_resampled30m.tif')

#alabama <- st_transform(alabama, "EPSG:5070")
#wma <- st_transform(wma, "EPSG:5070")

nlcd2011 <- get_nlcd(perdido, label='Landscape', year=2011)
#terra::writeRaster(nlcd2011, 'nlcd.tif', overwrite=TRUE)

# Simplify NLCD Categories
nlcdSimple = nlcd2011
nlcdSimple[nlcdSimple==11] = 1 #Wet areas are a 1 now
nlcdSimple[nlcdSimple %in% c(21, 22, 23, 24)] = 2 #All developed areas are 2
nlcdSimple[nlcdSimple %in% c(31, 52)] = 3 #Barren land and shrub/scrub are 3
nlcdSimple[nlcdSimple %in% c(41,42,43)] = 4 #All forest types are 4
nlcdSimple[nlcdSimple == 71] = 5 #Grassland is 5
nlcdSimple[nlcdSimple %in% c(81,82)] = 6 #And agriculture is 6

# Define Reclassified Values with Labels
tmp = data.frame('ID' = c(1, 2, 3, 4, 5, 6),
                 'category' = c('wetland', 'developed', 'open', 'forest', 'grassland', 'agriculture'))
nlcdSimple = categories(nlcdSimple, value=tmp)

# Plot the Simplified Raster
ggplot(nlcdSimple, aes(x=x, y=y, fill=category)) +
  geom_raster()+
  scale_fill_manual(values=c('blue', 'black', 'gray', 'darkolivegreen', 'orange', 'yellow'))


```